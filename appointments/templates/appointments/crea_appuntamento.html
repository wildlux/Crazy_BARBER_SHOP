{% extends 'appointments/base.html' %}

{% block title %}{% if modifica %}Modifica{% else %}Nuovo{% endif %} Appuntamento{% endblock %}

{% block content %}
<div class="card" style="max-width: 700px; margin: 0 auto;">
    <h1 style="color: #667eea; margin-bottom: 30px;">
        {% if modifica %}
            ✏️ Modifica Appuntamento
        {% else %}
            ➕ Nuovo Appuntamento
        {% endif %}
    </h1>
    
    <!-- FORM POST per creare/modificare -->
    <form method="POST">
        {% csrf_token %}
        
        <div class="form-group">
            <label>Barbiere:</label>
            {{ form.barbiere }}
            {% if form.barbiere.errors %}
                <p style="color: red;">{{ form.barbiere.errors }}</p>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label>Servizio:</label>
            {{ form.servizio }}
            {% if form.servizio.errors %}
                <p style="color: red;">{{ form.servizio.errors }}</p>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label>Data e Ora:</label>
            {{ form.data_ora }}
            {% if form.data_ora.errors %}
                <p style="color: red;">{{ form.data_ora.errors }}</p>
            {% endif %}
        </div>
        
         <div class="form-group">
             <label>Note (opzionale):</label>
             {{ form.note }}
             {% if form.note.errors %}
                 <p style="color: red;">{{ form.note.errors }}</p>
             {% endif %}
         </div>

         {% if 'stato' in form.fields %}
         <div class="form-group">
             <label>Stato:</label>
             {{ form.stato }}
             {% if form.stato.errors %}
                 <p style="color: red;">{{ form.stato.errors }}</p>
             {% endif %}
         </div>
         {% endif %}

         <button type="submit" class="btn btn-success">
             {% if modifica %}Salva Modifiche{% else %}Prenota{% endif %}
         </button>
        <a href="{% url 'lista_appuntamenti' %}" class="btn btn-secondary">Annulla</a>
    </form>
    
    <!-- Mostra slot disponibili con AJAX -->
    <div id="slot-disponibili" style="margin-top: 30px; background: #f5f5f5; padding: 20px; border-radius: 10px; display: none;">
        <h3 style="margin-bottom: 15px;">⏰ Orari Disponibili</h3>
        <div id="slot-list"></div>
    </div>
</div>

<script>
// JavaScript per caricare slot disponibili e disabilitare date passate
document.addEventListener('DOMContentLoaded', function() {
    const barbiereSelect = document.querySelector('[name="barbiere"]');
    const dataInput = document.querySelector('[name="data_ora"]');

    if (dataInput) {
        // Imposta min per disabilitare date passate
        const now = new Date();
        const minDateTime = now.toISOString().slice(0, 16);
        dataInput.setAttribute('min', minDateTime);
    }

    if (barbiereSelect && dataInput) {
        barbiereSelect.addEventListener('change', caricaSlot);
        dataInput.addEventListener('change', caricaSlot);
    }
    
    async function caricaSlot() {
        const barbiere = barbiereSelect.value;
        const dataTime = dataInput.value;
        
        if (!barbiere || !dataTime) return;
        
        const data = dataTime.split('T')[0];
        
        try {
            // Chiamata GET alla API
            const response = await fetch(`/api/slot-disponibili/?data=${data}&barbiere=${barbiere}`);
            const dati = await response.json();
            
            const container = document.getElementById('slot-disponibili');
            const slotList = document.getElementById('slot-list');
            
            if (dati.slot && dati.slot.length > 0) {
                container.style.display = 'block';
                slotList.innerHTML = '<p style="color: #4caf50; margin-bottom: 10px;">✅ Orari disponibili:</p>';
                
                const slotHtml = dati.slot.map(slot => 
                    `<button type="button" class="btn btn-secondary" style="margin: 5px; padding: 8px 20px; font-size: 14px;" onclick="selezionaSlot('${data}', '${slot.ora}')">${slot.ora}</button>`
                ).join('');
                
                slotList.innerHTML += slotHtml;
            } else {
                container.style.display = 'block';
                slotList.innerHTML = '<p style="color: #f44336;">❌ Nessun orario disponibile per questa data</p>';
            }
        } catch (error) {
            console.error('Errore:', error);
        }
    }
});

function selezionaSlot(data, ora) {
    const dataInput = document.querySelector('[name="data_ora"]');
    dataInput.value = `${data}T${ora}`;
}
</script>
{% endblock %}