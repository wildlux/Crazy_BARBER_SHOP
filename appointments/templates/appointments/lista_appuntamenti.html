{% extends 'appointments/base.html' %}

{% block title %}I Miei Appuntamenti{% endblock %}

{% block content %}
<div class="card">
    <h1 style="color: #667eea; margin-bottom: 30px;">üìÖ I Miei Appuntamenti</h1>
    
    <a href="{% url 'crea_appuntamento' %}" class="btn btn-success" style="margin-bottom: 20px;">
        ‚ûï Nuovo Appuntamento
    </a>
    
    <!-- FORM GET per filtrare -->
    <form method="GET" action="{% url 'lista_appuntamenti' %}" style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
        <h3 style="margin-bottom: 15px;">üîç Filtra Appuntamenti</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div class="form-group">
                <label>Data:</label>
                <input type="date" name="data" value="{{ filtro_data }}" class="form-control">
            </div>
            
            <div class="form-group">
                <label>Barbiere:</label>
                <select name="barbiere" class="form-control">
                    <option value="">Tutti</option>
                    {% for barbiere in barbieri %}
                        <option value="{{ barbiere.id }}" {% if filtro_barbiere == barbiere.id|stringformat:"s" %}selected{% endif %}>
                            {{ barbiere.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label>Stato:</label>
                <select name="stato" class="form-control">
                    <option value="">Tutti</option>
                    {% for stato_key, stato_label in stati %}
                        <option value="{{ stato_key }}" {% if filtro_stato == stato_key %}selected{% endif %}>
                            {{ stato_label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary">Cerca</button>
        <a href="{% url 'lista_appuntamenti' %}" class="btn btn-secondary">Reset Filtri</a>
    </form>
    
    <!-- Tabella appuntamenti -->
    {% if appuntamenti %}
    <table>
        <thead>
            <tr>
                <th>Data e Ora</th>
                <th>Barbiere</th>
                <th>Servizio</th>
                <th>Prezzo</th>
                <th>Stato</th>
                <th>Azioni</th>
            </tr>
        </thead>
        <tbody>
            {% for app in appuntamenti %}
            <tr>
                <td>{{ app.data_ora|date:"d/m/Y H:i" }}</td>
                <td>{{ app.barbiere.nome }}</td>
                <td>{{ app.servizio.nome }}</td>
                <td>‚Ç¨{{ app.servizio.prezzo }}</td>
                <td>
                    {% if app.stato == 'confermato' %}
                        <span class="badge badge-success">{{ app.get_stato_display }}</span>
                    {% elif app.stato == 'cancellato' %}
                        <span class="badge badge-danger">{{ app.get_stato_display }}</span>
                    {% else %}
                        <span class="badge badge-warning">{{ app.get_stato_display }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if app.stato == 'confermato' and not app.is_passato %}
                        <a href="{% url 'modifica_appuntamento' app.id %}" class="btn btn-primary" style="padding: 5px 15px; font-size: 14px;">
                            Modifica
                        </a>
                        
                        <!-- FORM POST per cancellare -->
                        <form method="POST" action="{% url 'cancella_appuntamento' app.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger" style="padding: 5px 15px; font-size: 14px;" onclick="return confirm('Sicuro di voler cancellare?')">
                                Cancella
                            </button>
                        </form>
                    {% else %}
                        <span style="color: #999;">-</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p style="text-align: center; color: #999; padding: 40px;">
            Nessun appuntamento trovato. <a href="{% url 'crea_appuntamento' %}">Prenota il tuo primo appuntamento!</a>
        </p>
    {% endif %}
</div>
{% endblock %}